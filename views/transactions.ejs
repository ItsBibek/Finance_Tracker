<style>
    .transaction-icon-income { background-color: #e6fffa; }
    .transaction-icon-expense { background-color: #fff5f5; }
</style>

<div class="row mb-4 align-items-center">
    <div class="col-md-6">
        <h1 class="mb-0" style="font-weight: 800; font-size: 2.5rem; color: #5b53f7; margin-bottom: 2rem;">Transactions</h1>

    </div>
    <div class="col-md-6 text-md-end d-flex gap-2 justify-content-end">
        <a href="/transactions/add" class="btn btn-primary" style="border-radius: 10px; display: inline-flex; align-items: center; gap: 8px;">
            <i class="fas fa-plus"></i> Add Transaction
        </a>
        <a href="/transactions/export" class="btn btn-success" style="border-radius: 10px; display: inline-flex; align-items: center; gap: 8px;">
            <i class="fas fa-file-export"></i> Export Transactions
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="budget-card" style="border-radius: 16px; overflow: hidden;">
            <div class="p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0" style="font-weight: 600;">Transaction Overview</h4>
                    <form action="/transactions" method="GET" id="periodForm">
                                                <select name="period" class="form-select form-select-sm" onchange="this.form.submit()" style="width: 150px;">
                            <option value="thisMonth" <%= period === 'thisMonth' ? 'selected' : '' %>>This Month</option>
                            <option value="lastMonth" <%= period === 'lastMonth' ? 'selected' : '' %>>Last Month</option>
                            <option value="last7days" <%= period === 'last7days' ? 'selected' : '' %>>Last 7 Days</option>
                        </select>
                    </form>
                </div>
                <div class="row text-center mb-4">
                    <div class="col-4">
                        <h6 class="text-muted mb-1">Total Income</h6>
                        <h4 class="fw-bold text-success"><%= formatNepaliCurrency(totalIncome) %></h4>
                    </div>
                    <div class="col-4">
                        <h6 class="text-muted mb-1">Total Expense</h6>
                        <h4 class="fw-bold text-danger"><%= formatNepaliCurrency(totalExpense) %></h4>
                    </div>
                    <div class="col-4">
                        <h6 class="text-muted mb-1">Net</h6>
                        <h4 class="fw-bold <%= netAmount >= 0 ? 'text-success' : 'text-danger' %>"><%= formatNepaliCurrency(netAmount) %></h4>
                    </div>
                </div>
                                <canvas id="transactionChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Centered Wrapper -->
<div class="row justify-content-center">
    <div class="col-xl-11">

        <!-- Content Row 2 (History) -->
        <div class="row">
            <div class="col-12">
                <div class="budget-card" style="border-radius: 16px; overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #4361ee, #3a56d4); padding: 20px; color: white; display: flex; justify-content: space-between; align-items: center;">
                        <h4 class="mb-0" style="font-weight: 600;"><i class="fas fa-history me-2"></i> Transaction History</h4>
                        <div class="d-flex gap-2">
                            <form action="/transactions" method="GET" id="filterForm" class="d-flex gap-3 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <span class="input-group-text bg-light" style="border-right: none; border-radius: 8px 0 0 8px;"><i class="fas fa-search"></i></span>
                                    <input type="text" id="transactionSearch" name="search" class="form-control" placeholder="Search..." value="<%= typeof search !== 'undefined' ? search : '' %>" style="border-left: none; border-radius: 0 8px 8px 0;">
                                </div>
                                <div class="input-group input-group-sm" style="width: 150px;">
                                    <label class="input-group-text bg-light" for="typeFilter"><i class="fas fa-filter"></i></label>
                                    <select name="type" id="typeFilter" class="form-select form-select-sm" onchange="this.form.submit()">
                                        <option value="all" <%= (typeof type === 'undefined' || type === 'all') ? 'selected' : '' %>>All Types</option>
                                        <option value="income" <%= (typeof type !== 'undefined' && type === 'income') ? 'selected' : '' %>>Income</option>
                                        <option value="expense" <%= (typeof type !== 'undefined' && type === 'expense') ? 'selected' : '' %>>Expense</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="p-0">
                        <% if (transactions.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" style="border-collapse: separate; border-spacing: 0;">
                                    <thead style="background-color: #f8fafc;">
                                        <tr>
                                            <th class="px-4 py-3" style="font-weight: 600; color: #4a5568;">Date</th>
                                            <th class="px-4 py-3" style="font-weight: 600; color: #4a5568;">Category</th>
                                            <th class="px-4 py-3" style="font-weight: 600; color: #4a5568;">Description</th>
                                            <th class="px-4 py-3" style="font-weight: 600; color: #4a5568;">Amount</th>
                                            <th class="px-4 py-3 text-center" style="font-weight: 600; color: #4a5568;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% transactions.forEach(function(transaction) { %>
                                            <tr>
                                                <td class="px-4 py-3">
                                                    <div class="d-flex align-items-center">
                                                          <% const iconBgClass = transaction.type === 'income' ? 'transaction-icon-income' : 'transaction-icon-expense'; %>
                                                          <div class="<%= iconBgClass %>" style="width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                                              <i class="<%= transaction.type === 'income' ? 'fas fa-arrow-down text-success' : 'fas fa-arrow-up text-danger' %>"></i>
                                                          </div>
                                                        <%= new Date(transaction.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="badge" style="background-color: #ebf4ff; color: #4361ee; font-weight: 500; padding: 6px 12px; border-radius: 20px;">
                                                        <%= transaction.category %>
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3" style="color: #4a5568;">
                                                    <%= transaction.description || '-' %>
                                                </td>
                                                                                                <td class="px-4 py-3 <%= transaction.type === 'income' ? 'text-success' : 'text-danger' %>" style="font-weight: 600; font-size: 1.05rem;">
                                                    <%= transaction.type === 'income' ? '+' : '-' %><%= formatNepaliCurrency(transaction.amount) %>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <div class="d-flex justify-content-center gap-2">
                                                        <a href="/transactions/<%= transaction._id %>/edit?period=<%= period %>" class="btn btn-sm" style="background-color: #ebf4ff; color: #4361ee; border: none; border-radius: 8px;">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form action="/transactions/<%= transaction._id %>?_method=DELETE" method="POST" class="d-inline">
                                                            <button type="submit" class="btn btn-sm" style="background-color: #fff5f5; color: #e53e3e; border: none; border-radius: 8px;" onclick="return confirm('Are you sure you want to delete this transaction?')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <% if (totalPages > 1) { %>
                                <div class="d-flex justify-content-center mt-4">
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination">
                                            <% for(let i = 1; i <= totalPages; i++) { %>
                                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                    <a class="page-link" href="/transactions?page=<%= i %>&type=<%= type %>&search=<%= search %>"><%= i %></a>
                                                </li>
                                            <% } %>
                                        </ul>
                                    </nav>
                                </div>
                            <% } %>
                        <% } else { %>
                            <div class="p-5 text-center">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #f8fafc; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                    <i class="fas fa-receipt" style="font-size: 32px; color: #a0aec0;"></i>
                                </div>
                                <h5 style="font-weight: 600; color: #4a5568;">No Transactions Yet</h5>
                                <p class="text-muted">Add your first transaction using the form on the left.</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function formatNepaliCurrency(num) {
        if (typeof num !== 'number') {
            return num;
        }
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const chartLabels = <%- JSON.stringify(chartData.labels) %>;
        const chartIncomeData = <%- JSON.stringify(chartData.income) %>;
        const chartExpenseData = <%- JSON.stringify(chartData.expense) %>;

        const ctx = document.getElementById('transactionChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Income',
                        data: chartIncomeData,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expense',
                        data: chartExpenseData,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: false,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatNepaliCurrency(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatNepaliCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });
</script>